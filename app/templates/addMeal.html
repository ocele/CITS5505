{% extends "home_base.html" %}
{% block title %} DailyBite - Add Meal{% endblock %}
{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='styleAddMeal.css') }}">
{% endblock %}
{% block content %}
    <div class="container wholeContainer">
        <form action="{{ url_for('main.addMeal')}}" method="POST">
            <h2>Add Meal</h2>
            {{ form.hidden_tag() }}

            <label for="mealType" class="form-label">Meal Type</label>
            {{ form.mealType(class="form-control", id="mealTypeInput") }}
            <br><br>

            <div class="container" id="foodinputcontainer">
                <label for="food" class="form-label">Food</label>
                <div class="input-group">
                    {{ form.food(class="form-control", id="foodInput") }}
                    <span class="input-group-text"><a href="#" id="searchFoodLink"><i class="fa-solid fa-magnifying-glass"></i></a></span>
                </div>
                {% if foodFound %}
                <br>
                <div class="alert alert-info alert-dismissible scrollable" id="foodFoundContainer">
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    {% for food in foodFound %}
                        <input type="radio" class="searchResult" id="{{ food.name }}" name="foundFood" value="{{ food.name }}" data-name="{{ food.name }}" data-quantity="{{ food.serving_size }}" data-unit="{{ food.serving_unit }}">
                        <label for="{{ food.name }}" class="form-label">
                            <h3>{{ food.name }}</h3>
                            <p> {{ food.calories }}kJ / {{ food.serving_size }} {{ food.serving_unit }}</p>
                        </label>
                        <br>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            <br><br>

            <label for="quantity" class="form-label">Quantity</label>
            <div class="input-group">
                {{ form.quantity(class="form-control", id="quantityInput") }}
                {{ form.unit(class="form-control", id="unitInput", readonly=True) }}
            </div>
            <br><br>
        

            <div class="container" id="historyContainer">
                <div class="row">
                    <div class="col-sm-2">
                        <p>History Items</p>
                    </div>
                    <div class="col-sm-10">
                        {% for item in historyItems %}
                        <div class="btn-group">
                            <a class="btn btn-primary historyItem" href="{{ url_for('main.addMeal', item=item) }}" data-name="{{ item }}">{{ item }}</a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <br><br>

            <div class="container" id="suggestionsContainer">
                <div class="row">
                    <div class="col-sm-2">
                        <p>Suggestions</p>
                    </div>
                    <div class="col-sm-10 scrollable suggestions">
                        {% for suggestion in suggestions %}
                            <div class="row suggestion">
                                <div class="col-sm-11">
                                    <h3>{{ suggestion.name }}</h3>
                                    <p> {{ suggestion.calories}}kJ / {{ suggestion.serving_size}} {{ suggestion.serving_unit}}</p>
                                </div>
                                <div class="col-sm-1">
                                    <a href="#" class="add-suggestion" data-name="{{ suggestion.name }}" data-quantity="{{ suggestion.serving_size}}" data-unit="{{ suggestion.serving_unit}}">
                                        <i class="fa-solid fa-plus"></i>
                                    </a>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <br>
            <div class="d-flex justify-content-between">
                <input type="submit" class="btn btn-secondary" value="Save">
                <a href="{{ url_for('main.dashboard') }}" class="btn btn-danger">Cancel</a>
            </div>
        </form>
        <br><br>
    </div>
{% endblock %}
{% block extra_js %}
    <script defer src="../static/addMeal.js"></script>

    <!-- Please don't move the scripts below to the .js. -->
    <!-- They have templates inside -->

    <script defer>

        const initialMealType = document.getElementById('mealTypeInput').value
        const historyItems = document.querySelectorAll('.historyItem');
        historyItems.forEach( historyItem => {
            historyItem.href = "{{ url_for('main.addMeal') }}?mealType=" + encodeURIComponent(initialMealType) + "&item=" + historyItem.getAttribute("data-name");
        });

        // JavaScript to dynamically update the search URL
        document.getElementById('foodInput').addEventListener('input', function () {
            const foodInputValue = document.getElementById('foodInput').value; // Get the value of the food input field
            const mealTypeValue = document.getElementById('mealTypeInput').value; // Get the value of the meal type input field
            const searchFoodLink = document.getElementById('searchFoodLink');
            searchFoodLink.href = "{{ url_for('main.addMeal') }}?food=" + encodeURIComponent(foodInputValue) + "&mealType=" + encodeURIComponent(mealTypeValue);
        });

        // Update the links when the meal type changes
        document.getElementById('mealTypeInput').addEventListener('change', function () {
            const foodInputValue = document.getElementById('foodInput').value; // Get the value of the food input field
            const mealTypeValue = document.getElementById('mealTypeInput').value; // Get the value of the meal type input field
            const searchFoodLink = document.getElementById('searchFoodLink');
            searchFoodLink.href = "{{ url_for('main.addMeal') }}?food=" + encodeURIComponent(foodInputValue) + "&mealType=" + encodeURIComponent(mealTypeValue);
            const historyItems = document.querySelectorAll('.historyItem');
            historyItems.forEach( historyItem => {
                historyItem.href = "{{ url_for('main.addMeal') }}?mealType=" + encodeURIComponent(mealTypeValue) + "&item=" + historyItem.getAttribute("data-name");
            });
        });

    
</script>
{% endblock %}