{% extends "home_base.html" %}

{% block title %}DailyBite Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='style_dashboard.css') }}">
<script defer>
    const messages = {{ get_flashed_messages()|tojson }};
    if (messages.length > 0) {
        alert(messages.join('\n'));
    }
</script>
{% endblock %}

{% block content %}

<div class="row">
    <!-- Calorie Intake Chart -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Calorie Intake Trend</h5>
                <div class="btn-group btn-group-sm calorie-trend-toggle" role="group">
                    <button type="button" class="btn btn-outline-primary time-range-btn" data-chart-target="calorieTrendChart" data-api-endpoint="/api/get_calorie_chart_options" data-range="day">Today</button>
                    <button type="button" class="btn btn-primary active time-range-btn" data-chart-target="calorieTrendChart" data-api-endpoint="/api/get_calorie_chart_options" data-range="week">Last 7 Days</button>
                    <button type="button" class="btn btn-outline-primary time-range-btn" data-chart-target="calorieTrendChart" data-api-endpoint="/api/get_calorie_chart_options" data-range="month">This Month</button>
                </div>
            </div>
            <div class="card-body">
                <div id="calorieTrendChart" style="height: 250px; width: 100%;"></div>
            </div>
        </div>
    </div>

    <!-- Nutrition Breakdown Chart -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
             <h5 class="mb-0">Nutrition Ratio (Today, kcal %)</h5>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-placeholder">
                    <div id="nutritionRatioChart" style="height: 250px; width: 100%;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaderboard -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Goal Achievement Leaderboard</h5>
                    <div class="btn-group btn-group-sm leaderboard-toggle" role="group">
                        <button type="button" class="btn btn-primary active leaderboard-period-btn" data-period="7d">Last 7 Days</button>
                        <button type="button" class="btn btn-outline-primary leaderboard-period-btn" data-period="30d">Last 30 Days</button>
                    </div>
                </div>
                <div class="card-body" id="leaderboardBody">
                    <p class="text-center text-muted" id="leaderboardLoading">Loading leaderboard...</p>
                    <ol class="list-group list-group-numbered" id="leaderboardList"style="display: none; max-height: 300px; overflow-y: auto;"></ol>
                    <p class="text-center text-danger" id="leaderboardError" style="display: none;">Could not load leaderboard data.</p>
                </div>
                <div class="card-footer text-muted small" id="leaderboardFooter" style="display: none;">
                    Ranking based on days meeting calorie goal (Â±10%).
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Recent Activity</h5>
                <span class="text-muted small">Last 5 Entries</span>
            </div>
            <div class="card-body" id="recentActivityList">
                {% if recent_logs %}
                    {% for log in recent_logs %}
                    <div class="activity-item d-flex align-items-center mb-2">
                        <div class="activity-indicator bg-primary me-2"></div>
                        <div class="activity-details flex-grow-1">
                            <span>{{ log.quantity_consumed }} {{ log.unit_consumed }} of {{ log.food_details.name if log.food_details else 'Unknown Food' }}</span>
                            <span class="text-muted small ms-1">({{ log.meal_type }})</span>
                        </div>
                        <div class="activity-time text-muted small">
                            {{ log.log_date.strftime('%H:%M') if log.log_date else '' }}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted text-center">No recent activity logged.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chartDom = document.getElementById('calorieTrendChart');
            let calorieChart = chartDom ? echarts.init(chartDom, null, { locale: 'EN' }) : null;
            const calorieButtons = document.querySelectorAll('.calorie-trend-toggle .time-range-btn');
        
            function updateCalorieChart(timeRange = 'week') {
                console.log('Fetching ECharts options for range:', timeRange);
                const currentChartDom = document.getElementById('calorieTrendChart');
                if (!currentChartDom || !calorieChart) {
                    console.error("Calorie chart instance or DOM element missing!");
                    return;
                }
                calorieChart.showLoading();
        
                fetch(`/api/get_calorie_chart_options?range=${timeRange}`)
                    .then(response => {
                        if (!response.ok) throw new Error(`Network response was not ok for chart options (status: ${response.status})`);
                        try {
                            return response.json();
                        } catch (e) {
                            throw new Error("Failed to parse JSON response");
                        }
                    })
                    .then(chartOptions => {
                        console.log('ECharts options received:', chartOptions);
                        if (!chartOptions || typeof chartOptions !== 'object') {
                            throw new Error("Received invalid chart options data");
                        }
                        calorieChart.hideLoading();
                        calorieChart.setOption(chartOptions, true);
                        console.log('ECharts option set.');
                    })
                    .catch(error => {
                        console.error('Error loading ECharts options:', error);
                        if(calorieChart) calorieChart.hideLoading();
                        currentChartDom.innerHTML = `<p class="text-danger text-center small mt-3">Could not load chart data. Please check console.</p>`;
                    });
            }
        
            calorieButtons.forEach(button => {
                button.addEventListener('click', function() {
                    this.closest('.btn-group').querySelectorAll('.time-range-btn').forEach(btn => {
                        btn.classList.remove('active', 'btn-primary');
                        btn.classList.add('btn-outline-primary');
                    });
                    this.classList.add('active', 'btn-primary');
                    this.classList.remove('btn-outline-primary');
        
                    const selectedRange = this.dataset.range;
                    updateCalorieChart(selectedRange);
                });
            });
        
            if (calorieChart) {
                updateCalorieChart('week');
            } else {
                 console.warn('DIV element with ID "calorieTrendChart" not found.');
            }
        
            window.addEventListener('resize', function() {
                if (calorieChart) {
                     setTimeout(() => {
                         calorieChart.resize();
                      }, 250);
                }
            });
        
            const nutritionCompDom = document.querySelector('.card-body .fa-chart-bar')?.closest('.card-body');
            if (nutritionCompDom && !document.getElementById('nutritionChart')) {
                nutritionCompDom.innerHTML = '<p class="text-muted text-center small mt-3">Nutrition Breakdown Chart Coming Soon</p>';
            }
            const categoryDom = document.querySelector('.card-body .fa-chart-pie')?.closest('.card-body');
             if (categoryDom && !document.getElementById('categoryChart')) {
                 categoryDom.innerHTML = '<p class="text-muted text-center small mt-3">Food Categories Chart Coming Soon</p>';
             }
            
            const nutritionRatioDom = document.getElementById('nutritionRatioChart');
            let nutritionRatioChart = nutritionRatioDom ? echarts.init(nutritionRatioDom, null, { locale: 'EN' }) : null;

            function updateNutritionRatioChart(targetDate = null) {
                console.log('Fetching nutrition ratio options for date:', targetDate || 'today');
                const currentChartDom = document.getElementById('nutritionRatioChart');
                if (!currentChartDom || !nutritionRatioChart) { /* ... */ return; }
                nutritionRatioChart.showLoading();

                let apiUrl = '/api/nutrition_ratio';
                if (targetDate) {
                    apiUrl += `?date=${targetDate}`;
                }

                fetch(apiUrl)
                    .then(response => {
                        if (!response.ok) throw new Error(`Network response was not ok for ratio options (status: ${response.status})`);
                        try { return response.json(); } catch (e) { throw new Error("Failed to parse JSON for ratio"); }
                    })
                    .then(chartOptions => {
                        console.log('Nutrition ratio options received:', chartOptions);
                        if (!chartOptions || typeof chartOptions !== 'object') {
                            throw new Error("Received invalid ratio chart options data");
                        }
                        nutritionRatioChart.hideLoading();
                        nutritionRatioChart.setOption(chartOptions, true);
                        console.log('Nutrition ratio chart updated.');
                    })
                    .catch(error => {
                        console.error('Error loading nutrition ratio chart:', error);
                        if(nutritionRatioChart) nutritionRatioChart.hideLoading();
                        currentChartDom.innerHTML = `<p class="text-danger text-center small mt-3">Could not load ratio data.</p>`;
                    });
            }

            if (nutritionRatioChart) {
                updateNutritionRatioChart();
            } else {
                console.warn('DIV element with ID "nutritionRatioChart" not found.');
            }

            window.addEventListener('resize', function() {
                setTimeout(() => {
                    if (calorieChart) calorieChart.resize();
                    if (nutritionCompChart) nutritionCompChart.resize();
                    if (nutritionRatioChart) nutritionRatioChart.resize();
                }, 250);
            }); 
            
            const leaderboardList = document.getElementById('leaderboardList');
            const leaderboardLoading = document.getElementById('leaderboardLoading');
            const leaderboardError = document.getElementById('leaderboardError');
            const leaderboardFooter = document.getElementById('leaderboardFooter');
            const leaderboardButtons = document.querySelectorAll('.leaderboard-toggle .leaderboard-period-btn');

            function updateLeaderboard(period = '7d') {
                console.log('Fetching leaderboard data for period:', period);
                if (!leaderboardList || !leaderboardLoading || !leaderboardError || !leaderboardFooter) {
                    console.error("Leaderboard DOM elements missing!");
                    return;
                }

                leaderboardLoading.style.display = 'block';
                leaderboardList.style.display = 'none';
                leaderboardError.style.display = 'none';
                leaderboardFooter.style.display = 'none';
                leaderboardList.innerHTML = '';

                fetch(`/api/goal_leaderboard?period=${period}`)
                    .then(response => {
                        if (!response.ok) throw new Error(`Network response was not ok for leaderboard (status: ${response.status})`);
                        try { return response.json(); } catch (e) { throw new Error("Failed to parse JSON for leaderboard"); }
                    })
                    .then(leaderboardData => {
                        console.log('Leaderboard data received:', leaderboardData);
                        leaderboardLoading.style.display = 'none';

                        if (!Array.isArray(leaderboardData)) {
                            throw new Error("Received invalid leaderboard data format");
                        }

                        if (leaderboardData.length === 0) {
                            leaderboardList.innerHTML = '<li class="list-group-item text-muted text-center">No data available for this period.</li>';
                        } else {
                            leaderboardData.forEach(entry => {
                                const listItem = document.createElement('li');
                                listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                                const nameDiv = document.createElement('div');
                                nameDiv.className = 'ms-2 me-auto';
                                const rankSpan = document.createElement('span');
                                rankSpan.className = 'me-2';

                                let rankDisplay = '';
                                if (entry.rank === 1) {
                                    rankDisplay = 'ðŸ¥‡ ';
                                } else if (entry.rank === 2) {
                                    rankDisplay = 'ðŸ¥ˆ ';
                                } else if (entry.rank === 3) {
                                    rankDisplay = 'ðŸ¥‰ ';
                                } else {
                                    rankDisplay = `${entry.rank}. `;
                                }
                                rankSpan.textContent = rankDisplay;

                                nameDiv.appendChild(rankSpan);
                                nameDiv.appendChild(document.createTextNode(entry.last_name || 'Unknown'));

                                const badge = document.createElement('span');
                                let badgeClass = 'bg-secondary';
                                if (entry.rank === 1) badgeClass = 'bg-warning text-dark';
                                else if (entry.rank === 2) badgeClass = 'bg-info text-dark';
                                else if (entry.rank === 3) badgeClass = 'bg-success';

                                badge.className = `badge ${badgeClass} rounded-pill`;
                                badge.textContent = `${entry.days_achieved} ${entry.days_achieved === 1 ? 'day' : 'days'}`;

                                listItem.appendChild(nameDiv);
                                listItem.appendChild(badge);
                                leaderboardList.appendChild(listItem);
                            });
                        }

                        leaderboardList.style.display = 'block';
                        leaderboardFooter.style.display = 'block';
                        console.log('Leaderboard updated.');

                    })
                    .catch(error => {
                        console.error('Error loading leaderboard:', error);
                        leaderboardLoading.style.display = 'none';
                        leaderboardError.style.display = 'block';
                        leaderboardList.style.display = 'none';
                        leaderboardFooter.style.display = 'none';
                    });
            }

            leaderboardButtons.forEach(button => {
                button.addEventListener('click', function() {
                    this.closest('.btn-group').querySelectorAll('.leaderboard-period-btn').forEach(btn => {
                        btn.classList.remove('active', 'btn-primary');
                        btn.classList.add('btn-outline-primary');
                    });
                    this.classList.add('active', 'btn-primary');
                    this.classList.remove('btn-outline-primary');

                    const selectedPeriod = this.dataset.period;
                    updateLeaderboard(selectedPeriod);
                });
            });

            if (leaderboardList) {
                updateLeaderboard('7d');
            } else {
                console.warn('Element with ID "leaderboardList" not found.');
            }

        });
        
        </script>
{% endblock %}