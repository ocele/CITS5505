{% extends "home_base.html" %}

{% block title %}DailyBite Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='style_dashboard.css') }}">

{% endblock %}

{% block content %}

<div class="row row-cols-1 row-cols-md-2 g-4">
    <!-- Calorie Intake Chart -->
    <div class="col-12 col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Calorie Intake Trend</h5>
                <div class="btn-group btn-group-sm calorie-trend-toggle" role="group">
                    <button type="button" class="btn btn-outline-warning time-range-btn"
                        data-chart-target="calorieTrendChart" data-api-endpoint="/api/get_calorie_chart_options"
                        data-range="day">Today</button>
                    <button type="button" class="btn btn-warning active time-range-btn"
                        data-chart-target="calorieTrendChart" data-api-endpoint="/api/get_calorie_chart_options"
                        data-range="week">Last 7 Days</button>
                    <button type="button" class="btn btn-outline-warning time-range-btn"
                        data-chart-target="calorieTrendChart" data-api-endpoint="/api/get_calorie_chart_options"
                        data-range="month">This Month</button>
                </div>
            </div>
            <div class="card-body">
                <div id="calorieTrendChart" style="height: 250px; width: 100%;"></div>
            </div>
        </div>
    </div>

    <!-- Leaderboard -->
    <div class="col-12 col-md-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Leaderboard</h5>
                    <div class="btn-group btn-group-sm leaderboard-toggle" role="group">
                        <button type="button" class="btn btn-warning active leaderboard-period-btn" data-period="7d">
                            <span class="full-text">Last 7 Days</span>
                            <span class="short-text">W</span>
                        </button>
                        <button type="button" class="btn btn-outline-warning leaderboard-period-btn" data-period="30d">
                            <span class="full-text">This Month</span>
                            <span class="short-text">M</span>
                        </button>
                    </div>
                </div>
                <div class="card-body d-flex flex-column" id="leaderboardBody">
                    <p class="text-center text-muted" id="leaderboardLoading" style="display: none;">Loading leaderboard...</p>
                    <ol class="list-group flex-grow-1" id="leaderboardList" style="max-height: 200px; overflow-y: auto; display: none;"></ol>
                    <p class="text-center text-danger" id="leaderboardError" style="display: none;">Could not load leaderboard data.</p>
                <div class="card-footer text-muted small mt-auto" id="leaderboardFooter" style="display: none;">
                    Ranking based on days meeting calorie goal (Â±10%).
                </div>
            </div>
            </div>
    </div>

    <!-- Nutrition Breakdown Chart -->
    <div class="col">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Nutrition Ratio (Today, kcal %)</h5>
            </div>
            <div class="card-body">
                <div class="chart-placeholder">
                    <div id="nutritionRatioChart" style="height: 250px; width: 100%;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="col">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Recent Activity</h5>
                <span class="text-muted small">Last 5 Entries</span>
            </div>
            <div class="card-body" id="recentActivityList">
                {% if recent_logs %}
                {% for log in recent_logs %}
                <div class="activity-item d-flex align-items-center mb-2">
                    <div class="activity-indicator bg-primary me-2"></div>
                    <div class="activity-details flex-grow-1">
                        <span>{{ log.quantity_consumed }} {{ log.unit_consumed }} of {{ log.food_details.name if
                            log.food_details else 'Unknown Food' }}</span>
                        <span class="text-muted small ms-1">({{ log.meal_type }})</span>
                    </div>
                    <div class="activity-time text-muted small">
                        {{ log.log_date.strftime('%m-%d %H:%M') if log.log_date else '' }}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="card-body">
                    <p class="text-muted text-center small">No recent activity logged.</p>

                    <ul class="list-group mb-5">
                        <li class="list-group-item d-flex align-items-center">
                            <div class="placeholder-glow rounded-circle me-3"
                                style="width:12px; height:12px; background-color:#e0e0e0;"></div>
                            <div class="flex-grow-1 placeholder-glow">
                                <span class="placeholder col-8"></span>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <div class="placeholder-glow rounded-circle me-3"
                                style="width:12px; height:12px; background-color:#e0e0e0;"></div>
                            <div class="flex-grow-1 placeholder-glow">
                                <span class="placeholder col-6"></span>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <div class="placeholder-glow rounded-circle me-3"
                                style="width:12px; height:12px; background-color:#e0e0e0;"></div>
                            <div class="flex-grow-1 placeholder-glow">
                                <span class="placeholder col-7"></span>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <div class="placeholder-glow rounded-circle me-3"
                                style="width:12px; height:12px; background-color:#e0e0e0;"></div>
                            <div class="flex-grow-1 placeholder-glow">
                                <span class="placeholder col-6"></span>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <div class="placeholder-glow rounded-circle me-3"
                                style="width:12px; height:12px; background-color:#e0e0e0;"></div>
                            <div class="flex-grow-1 placeholder-glow">
                                <span class="placeholder col-7"></span>
                            </div>
                        </li>
                    </ul>

                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1100">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% for category, message in messages %}
        <div class="toast align-items-center text-bg-{{ category }} border-0 shadow show" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">{{ message }}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
      {% endfor %}
    {% endwith %}
</div>

  
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
      const toastElList = [].slice.call(document.querySelectorAll('.toast'));
      toastElList.forEach(function (toastEl) {
        const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
        toast.show();
      });
    });
</script>
  
<script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const chartDom = document.getElementById('calorieTrendChart');
        let calorieChart = chartDom ? echarts.init(chartDom, null, { locale: 'EN' }) : null;
        const calorieButtons = document.querySelectorAll('.calorie-trend-toggle .time-range-btn');

        function updateCalorieChart(timeRange = 'week') {
            console.log('Fetching ECharts options for range:', timeRange);
            const currentChartDom = document.getElementById('calorieTrendChart');
            if (!currentChartDom || !calorieChart) {
                console.error("Calorie chart instance or DOM element missing!");
                return;
            }
            calorieChart.showLoading();

            fetch(`/api/get_calorie_chart_options?range=${timeRange}`)
                .then(response => {
                    if (!response.ok) throw new Error(`Network response was not ok for chart options (status: ${response.status})`);
                    try {
                        return response.json();
                    } catch (e) {
                        throw new Error("Failed to parse JSON response");
                    }
                })
                .then(chartOptions => {
                    console.log('ECharts options received:', chartOptions);
                    if (!chartOptions || typeof chartOptions !== 'object') {
                        throw new Error("Received invalid chart options data");
                    }
                    calorieChart.hideLoading();
                    calorieChart.setOption(chartOptions, true);
                    console.log('ECharts option set.');
                })
                .catch(error => {
                    console.error('Error loading ECharts options:', error);
                    if (calorieChart) calorieChart.hideLoading();
                    currentChartDom.innerHTML = `<p class="text-danger text-center small mt-3">Could not load chart data. Please check console.</p>`;
                });
        }

        calorieButtons.forEach(button => {
            button.addEventListener('click', function () {
                this.closest('.btn-group').querySelectorAll('.time-range-btn').forEach(btn => {
                    btn.classList.remove('active', 'btn-warning');
                    btn.classList.add('btn-outline-warning');
                });
                this.classList.add('active', 'btn-warning');
                this.classList.remove('btn-outline-warning');

                const selectedRange = this.dataset.range;
                updateCalorieChart(selectedRange);
            });
        });

        if (calorieChart) {
            updateCalorieChart('week');
        } else {
            console.warn('DIV element with ID "calorieTrendChart" not found.');
        }

        window.addEventListener('resize', function () {
            if (calorieChart) {
                setTimeout(() => {
                    calorieChart.resize();
                }, 250);
            }
        });

        const nutritionCompDom = document.querySelector('.card-body .fa-chart-bar')?.closest('.card-body');
        if (nutritionCompDom && !document.getElementById('nutritionChart')) {
            nutritionCompDom.innerHTML = '<p class="text-muted text-center small mt-3">Nutrition Breakdown Chart Coming Soon</p>';
        }
        const categoryDom = document.querySelector('.card-body .fa-chart-pie')?.closest('.card-body');
        if (categoryDom && !document.getElementById('categoryChart')) {
            categoryDom.innerHTML = '<p class="text-muted text-center small mt-3">Food Categories Chart Coming Soon</p>';
        }

        const nutritionRatioDom = document.getElementById('nutritionRatioChart');
        let nutritionRatioChart = nutritionRatioDom ? echarts.init(nutritionRatioDom, null, { locale: 'EN' }) : null;

        function updateNutritionRatioChart(targetDate = null) {
            console.log('Fetching nutrition ratio options for date:', targetDate || 'today');
            const currentChartDom = document.getElementById('nutritionRatioChart');
            if (!currentChartDom || !nutritionRatioChart) { /* ... */ return; }
            nutritionRatioChart.showLoading();

            let apiUrl = '/api/nutrition_ratio';
            if (targetDate) {
                apiUrl += `?date=${targetDate}`;
            }

            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) throw new Error(`Network response was not ok for ratio options (status: ${response.status})`);
                    try { return response.json(); } catch (e) { throw new Error("Failed to parse JSON for ratio"); }
                })
                .then(chartOptions => {
                    console.log('Nutrition ratio options received:', chartOptions);
                    if (!chartOptions || typeof chartOptions !== 'object') {
                        throw new Error("Received invalid ratio chart options data");
                    }
                    nutritionRatioChart.hideLoading();
                    nutritionRatioChart.setOption(chartOptions, true);
                    console.log('Nutrition ratio chart updated.');
                })
                .catch(error => {
                    console.error('Error loading nutrition ratio chart:', error);
                    if (nutritionRatioChart) nutritionRatioChart.hideLoading();
                    currentChartDom.innerHTML = `
                        <div class="text-center placeholder-glow ">
                            <div
                            class="placeholder mx-auto"
                            style="
                                width: 200px;
                                height: 200px;
                                border: 20px solid #e0e0e0;
                                border-radius: 50%;
                                background-color: transparent;
                            "
                            ></div>
                        </div>
                        <p class="text-center text-muted small mt-4">
                            You havenâ€™t added any data today.<br>
                        </p>
                    `;
                });
        }

        if (nutritionRatioChart) {
            updateNutritionRatioChart();
        } else {
            console.warn('DIV element with ID "nutritionRatioChart" not found.');
        }

        window.addEventListener('resize', function () {
            setTimeout(() => {
                if (calorieChart) calorieChart.resize();
                if (nutritionCompChart) nutritionCompChart.resize();
                if (nutritionRatioChart) nutritionRatioChart.resize();
            }, 250);
        });

        const leaderboardList = document.getElementById('leaderboardList');
        const leaderboardLoading = document.getElementById('leaderboardLoading');
        const leaderboardError = document.getElementById('leaderboardError');
        const leaderboardFooter = document.getElementById('leaderboardFooter');
        const leaderboardButtons = document.querySelectorAll('.leaderboard-toggle .leaderboard-period-btn');

        function updateLeaderboard(period = '7d') {
            console.log('Fetching leaderboard data for period:', period);
            if (!leaderboardList || !leaderboardLoading || !leaderboardError || !leaderboardFooter) {
                console.error("Leaderboard DOM elements missing!");
                return;
            }

            leaderboardLoading.style.display = 'block';
            leaderboardList.style.display = 'none';
            leaderboardError.style.display = 'none';
            leaderboardFooter.style.display = 'none';
            leaderboardList.innerHTML = '';

            fetch(`/api/goal_leaderboard?period=${period}`)
                .then(response => {
                    if (!response.ok) throw new Error(`Network response was not ok for leaderboard (status: ${response.status})`);
                    try { return response.json(); } catch (e) { throw new Error("Failed to parse JSON for leaderboard"); }
                })
                .then(leaderboardData => {
                    console.log('Leaderboard data received:', leaderboardData);
                    leaderboardLoading.style.display = 'none';

                    if (!Array.isArray(leaderboardData)) {
                        throw new Error("Received invalid leaderboard data format");
                    }

                    if (leaderboardData.length === 0) {
                        leaderboardList.innerHTML = `
                             <div class="text-center py-4 placeholder-glow">
                            <i 
                                class="fa-solid fa-trophy fa-5x" 
                                style="color: #e0e0e0; opacity: .6;"
                            ></i>
                            </div>
                            <p class="text-center text-muted small mt-4">
                            No data available for this period.
                            </p>
                        `;
                    } else {
                        const medals = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'];
                        const medalRankMap = {};  // æ˜ å°„ rank -> medal indexï¼ˆæœ€å¤š3ä¸ªï¼‰
                        let medalAssigned = 0;

                        leaderboardData.forEach(entry => {
                            // æœ€å¤šåªå¤„ç†ä¸‰ç§ä¸åŒ rank
                            if (!(entry.rank in medalRankMap)) {
                                if (medalAssigned >= 3) return; // è¶…è¿‡å‰ä¸‰åï¼Œç›´æŽ¥ä¸æ¸²æŸ“
                                medalRankMap[entry.rank] = medalAssigned;
                                medalAssigned += 1;
                            }

                            const medalIndex = medalRankMap[entry.rank];

                            const listItem = document.createElement('li');
                            listItem.className = 'list-group-item d-flex justify-content-between align-items-center py-3';

                            const nameDiv = document.createElement('div');
                            nameDiv.className = 'ms-2 me-auto';

                            const rankSpan = document.createElement('span');
                            rankSpan.className = 'me-3';
                            rankSpan.style.fontSize = '1.1em';
                            rankSpan.textContent = medals[medalIndex] || '';

                            nameDiv.appendChild(rankSpan);
                            nameDiv.appendChild(document.createTextNode(entry.full_name || 'Unknown User'));

                            const badge = document.createElement('span');
                            let badgeClass = 'bg-secondary';
                            if (medalIndex === 0) badgeClass = 'bg-warning text-dark';
                            else if (medalIndex === 1) badgeClass = 'bg-info text-dark';
                            else if (medalIndex === 2) badgeClass = 'bg-success';

                            badge.className = `badge ${badgeClass} rounded-pill`;
                            badge.textContent = `${entry.days_met} ${entry.days_met === 1 ? 'day met' : 'days met'}`;

                            listItem.appendChild(nameDiv);
                            listItem.appendChild(badge);
                            leaderboardList.appendChild(listItem);
                        });                   
                    }

                    leaderboardList.style.display = 'block';
                    leaderboardFooter.style.display = 'block';
                    console.log('Leaderboard updated.');

                })
                .catch(error => {
                    console.error('Error loading leaderboard:', error);
                    leaderboardLoading.style.display = 'none';
                    leaderboardError.style.display = 'block';
                    leaderboardList.style.display = 'none';
                    leaderboardFooter.style.display = 'none';
                });
        }

        leaderboardButtons.forEach(button => {
            button.addEventListener('click', function () {
                this.closest('.btn-group').querySelectorAll('.leaderboard-period-btn').forEach(btn => {
                    btn.classList.remove('active', 'btn-warning');
                    btn.classList.add('btn-outline-warning');
                });
                this.classList.add('active', 'btn-warning');
                this.classList.remove('btn-outline-warning');

                const selectedPeriod = this.dataset.period;
                updateLeaderboard(selectedPeriod);
            });
        });

        if (leaderboardList) {
            updateLeaderboard('7d');
        } else {
            console.warn('Element with ID "leaderboardList" not found.');
        }

    });

</script>
{% endblock %}